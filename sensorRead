#include <DHT.h>
#include <DHT_U.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <LiquidCrystal.h>
#include <esp_sleep.h>

#define DHTTYPE DHT11
#define DHTPIN 3
#define successLED A0
#define connectLED A1
#define failLED A2
#define deepSleep 2
#define dhtPower A7
#define lcdPower A6

const char* ssid = "YOUR_SSID";         // Your WiFi SSID
const char* password = "YOUR_PASSWORD";     // Your WiFi Password
const char* serverUrl = "http://192.168.1.100/dataReciever.php"; // Your server endpoint


DHT dht(DHTPIN, DHTTYPE);

const int rs = 12, en = 11, d4 = 10, d5 = 9, d6 = 8, d7 = 7;
LiquidCrystal lcd(rs, en, d4, d5, d6, d7);


void wifiConnectActive(){

  digitalWrite(connectLED, HIGH);

  Serial.print("Connecting to WiFi");
  WiFi.begin(ssid, password);
  unsigned long startAttemptTime = millis();
  const unsigned long wifiTimeout = 5000; // 10 seconds timeout

  while (WiFi.status() != WL_CONNECTED && millis() - startAttemptTime < wifiTimeout) {
    delay(500);
    Serial.print(".");
  }

  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("\nFailed to connect to WiFi. Rebooting...");
    digitalWrite(failLED, HIGH);
    delay(500);
    digitalWrite(failLED, LOW);
    digitalWrite(connectLED, LOW);

    WiFi.disconnect();
    return;
  }

  Serial.println("\nWiFi connected successfully!");
  Serial.print("IP Address: ");
  Serial.println(WiFi.localIP());
  digitalWrite(successLED,HIGH);
  delay(500);
  digitalWrite(successLED,LOW);
  digitalWrite(connectLED, LOW);
}


void wifiConnectPassive(){;

  Serial.print("Connecting to WiFi");
  WiFi.begin(ssid, password);
  unsigned long startAttemptTime = millis();
  const unsigned long wifiTimeout = 8000; // 8 seconds timeout

  while (WiFi.status() != WL_CONNECTED && millis() - startAttemptTime < wifiTimeout) {
    delay(500);
    Serial.print(".");
  }

  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("\nFailed to connect to WiFi. Rebooting...");
    
    WiFi.disconnect();
    return;
    
  }

  Serial.println("\nWiFi connected successfully!");
  Serial.print("IP Address: ");
  Serial.println(WiFi.localIP());
}


void setDeepSleep(){

  digitalWrite(lcdPower, LOW);
  digitalWrite(dhtPower, LOW);
  digitalWrite(failLED, LOW);
  digitalWrite(connectLED, LOW);
  digitalWrite(successLED, LOW);

  esp_deep_sleep_start();

}


void sendDataActive(float temperature, float humidity){

  String postData = "temperature=" + String(temperature) + "&humidity=" + String(humidity);

  Serial.print("URL: ");
  Serial.println(serverUrl);
  Serial.print("POST Data: ");
  Serial.println(postData);

  HTTPClient http;
  http.begin(serverUrl);
  http.addHeader("Content-Type", "application/x-www-form-urlencoded");

  int httpResponseCode = http.POST(postData);

  if (httpResponseCode > 0) {
    String response = http.getString();
    Serial.print("Server response:");
    Serial.println(response);

    if (httpResponseCode == 200) {
      delay(500);
      digitalWrite(successLED,HIGH);
      digitalWrite(connectLED, HIGH);
      delay(500);
      digitalWrite(successLED,LOW);
      digitalWrite(connectLED, LOW);
    }
     
    else {
      Serial.print("Error: ");
      Serial.println(http.errorToString(httpResponseCode));
      delay(500);
      digitalWrite(failLED,HIGH);
      digitalWrite(connectLED, HIGH);
      delay(500);
      digitalWrite(failLED,LOW);
      digitalWrite(connectLED, LOW);
    }

    http.end();
  }

  WiFi.disconnect();

}

void sendDataPassive(float temperature, float humidity){

  String postData = "temperature=" + String(temperature) + "&humidity=" + String(humidity);

  Serial.print("URL: ");
  Serial.println(serverUrl);
  Serial.print("POST Data: ");
  Serial.println(postData);

  HTTPClient http;
  http.begin(serverUrl);
  http.addHeader("Content-Type", "application/x-www-form-urlencoded");

  int httpResponseCode = http.POST(postData);

  if (httpResponseCode > 0) {
    String response = http.getString();
    Serial.print("Server response:");
    Serial.println(response);

    if (httpResponseCode == 200) {
    }
     
    else {
      Serial.print("Error: ");
      Serial.println(http.errorToString(httpResponseCode));
    }

    http.end();
  }

  WiFi.disconnect();

}


void activeMode(){

  Serial.println("ACTIVE MODE");

  digitalWrite(lcdPower, HIGH);
  digitalWrite(dhtPower, HIGH);

  wifiConnectActive();

  delay(1500);

  lcd.begin(16,2);
  delay(100);

  float temperature = dht.readTemperature();
  float humidity = dht.readHumidity();

  digitalWrite(dhtPower, LOW);

  if (isnan(temperature) || isnan(humidity)) {
    Serial.println("Failed to read from DHT sensor!");
    digitalWrite(failLED, HIGH);
    delay(500);
    digitalWrite(failLED, LOW);
  } else {
    Serial.print("Temperature: ");
    Serial.print(temperature);
    Serial.print(" °C, Humidity: ");
    Serial.print(humidity);
    Serial.println(" %");

    digitalWrite(successLED, HIGH);
    delay(500);
    digitalWrite(successLED, LOW);

    lcd.setCursor(0, 0);
    lcd.print("Humidity: ");
    lcd.print(humidity);
    lcd.print("%");

    lcd.setCursor(0, 1);
    lcd.print("Temp: ");
    lcd.print(temperature);
    lcd.print("C");

    if (WiFi.status() == WL_CONNECTED) {
      sendDataActive(temperature, humidity);
    }
    else {
      Serial.println("WiFi not connected, skipping data send");
    }

    delay(1 * 60 * 1000);
  }
}


void passiveMode(){

  digitalWrite(lcdPower, LOW);

  digitalWrite(dhtPower, HIGH);
  delay(2000);

  Serial.println("PASSIVE MODE");

  wifiConnectPassive();

  float temperature = dht.readTemperature();
  float humidity = dht.readHumidity();

  digitalWrite(dhtPower, LOW);

  if (isnan(temperature) || isnan(humidity)) {
    Serial.println("Failed to read from DHT sensor!");
    delay(500);
  } else {
    Serial.print("Temperature: ");
    Serial.print(temperature);
    Serial.print(" °C, Humidity: ");
    Serial.print(humidity);
    Serial.println(" %");
    
    delay(500);
  }

  if (WiFi.status() == WL_CONNECTED) {
    sendDataPassive(temperature, humidity);
  }
  else {
    Serial.println("WiFi not connected, skipping data send");
  }

  esp_sleep_enable_timer_wakeup(15 * 60 * 1000000);
  esp_sleep_enable_ext0_wakeup(GPIO_NUM_5, 1);
  setDeepSleep();
}


void setup() {

  Serial.begin(115200);
  dht.begin();

  pinMode(deepSleep, INPUT);

  pinMode(successLED, OUTPUT);
  digitalWrite(successLED, LOW);
  pinMode(connectLED, OUTPUT);
  digitalWrite(connectLED, LOW);
  pinMode(failLED, OUTPUT);
  digitalWrite(failLED, LOW);

  pinMode(lcdPower, OUTPUT);
  pinMode(dhtPower, OUTPUT);

  digitalWrite(dhtPower, LOW);
  digitalWrite(lcdPower,LOW);

}


void loop(){

  delay(500);

  if (digitalRead(deepSleep) == HIGH) {
    Serial.println("Switch on... active mode");
    activeMode();
  } else {
    Serial.println("Switch off... passive mode");
    passiveMode();
  }

}
